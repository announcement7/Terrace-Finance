<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Metadata -->
    <title>Instant Loan Options Kenya | M-PESA Loans - Techspace Finance</title>
    <meta name="description" content="Get instant loans in Kenya. Check your loan eligibility and receive M-PESA loans within minutes. Compare loan options with transparent terms and instant approval.">
    <meta name="keywords" content="instant loans Kenya, M-PESA loans, check loan eligibility, quick loans Kenya, online loans Kenya, instant cash loans">
    <meta name="author" content="Techspace Finance">
    <meta name="robots" content="index, follow">
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="Instant Loan Options Kenya | Techspace Finance">
    <meta property="og:description" content="Get instant loans in Kenya with transparent terms and instant M-PESA disbursement.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://via.placeholder.com/1200x630/22c55e/ffffff?text=Techspace+Finance">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Instant Loan Options Kenya">
    <meta name="twitter:description" content="Get instant loans in Kenya with transparent terms.">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’°</text></svg>">
    <link rel="alternate icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjBFQzRGQjBCNEE4QzExRUFBRkE2RjhGMEVCQjVFQjVCIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjBFQzRGQjBDNEE4QzExRUFBRkE2RjhGMEVCQjVFQjVCIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MEVDNEZCMDk0QThDMTFFQUFGQTZGOEYwRUJCNUVCNUIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MEVDNEZCMEE0QThDMTFFQUFGQTZGOEYwRUJCNUVCNUIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4B">
    
    <!-- Schema Markup for Ratings -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FinancialProduct",
      "name": "Techspace Finance Instant Loans",
      "description": "Quick and instant loans in Kenya with M-PESA disbursement",
      "provider": {
        "@type": "FinancialService",
        "name": "Techspace Finance",
        "aggregateRating": {
          "@type": "AggregateRating",
          "ratingValue": "4.7",
          "reviewCount": "2543",
          "bestRating": "5",
          "worstRating": "1"
        }
      },
      "offers": {
        "@type": "Offer",
        "priceCurrency": "KES",
        "availability": "https://schema.org/InStock"
      }
    }
    </script>
    
    <!-- Analytics Placeholder - Add your tracking IDs -->
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    
    <!-- Facebook Pixel -->
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', 'YOUR_PIXEL_ID');
      fbq('track', 'PageView');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #1f2937;
            background: #f9fafb;
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .navbar {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        h1 {
            color: #d946ef;
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.5s ease-out;
        }

        .greeting {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 2rem;
            animation: fadeInUp 0.5s ease-out 0.1s backwards;
        }

        .loan-cards {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .loan-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }

        .loan-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .loan-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #d946ef;
            margin-bottom: 1.5rem;
        }

        .loan-details {
            display: grid;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .detail-value {
            color: #1f2937;
            font-weight: 500;
        }

        .tracking-number {
            font-size: 0.75rem;
            color: #9ca3af;
            word-break: break-all;
        }

        .highlight-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .highlight-box strong {
            color: #92400e;
        }

        .chart-container {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .chart-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .pie-chart {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-visual {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(
                #d946ef 0deg,
                #d946ef var(--principal-deg),
                #f59e0b var(--principal-deg),
                #f59e0b var(--interest-deg),
                #ef4444 var(--interest-deg),
                #ef4444 360deg
            );
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-legend {
            flex: 1;
            min-width: 150px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .btn-get-loan {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #d946ef 0%, #c026d3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-get-loan:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(217, 70, 239, 0.4);
        }

        .btn-get-loan:active {
            transform: translateY(0);
        }

        .no-options {
            text-align: center;
            padding: 3rem 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .no-options svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            color: #ef4444;
        }

        .no-options h2 {
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .no-options p {
            color: #6b7280;
            margin-bottom: 2rem;
        }

        .btn-back {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: #22c55e;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f4f6;
            border-top: 5px solid #d946ef;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 1rem;
            color: #6b7280;
            font-size: 1.1rem;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-container {
            max-width: 600px;
            margin: 2rem auto;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-top: 4px solid #ef4444;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            color: #ef4444;
        }

        .error-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .error-message {
            color: #6b7280;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #9ca3af;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .modal-content {
            margin-bottom: 1.5rem;
        }

        .modal-summary {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .modal-detail {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-detail:last-child {
            border-bottom: none;
        }

        .modal-label {
            font-weight: 600;
            color: #6b7280;
        }

        .modal-value {
            font-weight: 600;
            color: #1f2937;
        }

        .modal-highlight {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-modal {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #d946ef 0%, #c026d3 100%);
            color: white;
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(217, 70, 239, 0.4);
        }

        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .greeting {
                font-size: 1rem;
            }

            .loan-amount {
                font-size: 2rem;
            }

            .loan-card {
                padding: 1.5rem;
            }

            .modal {
                padding: 1.5rem;
            }

            .chart-visual {
                width: 100px;
                height: 100px;
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        /* Image optimization - lazy loading support */
        img {
            max-width: 100%;
            height: auto;
        }

        img[loading="lazy"] {
            opacity: 0;
            transition: opacity 0.3s;
        }

        img[loading="lazy"].loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" role="status" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loading-text">Loading your loan options...</div>
    </div>

    <!-- Navigation -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <a href="index.html" class="logo" aria-label="Techspace Finance Home">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Techspace Finance
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container" role="main">
        <h1>Available Loan Options</h1>
        <p class="greeting" id="greeting">Loading your loan options...</p>
        <div class="loan-cards" id="loanCards"></div>
    </main>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Confirm Loan Application</h2>
                <button class="modal-close" onclick="closeModal()" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-content" id="modalContent">
            </div>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-modal btn-confirm" onclick="confirmLoan()">Confirm & Proceed</button>
            </div>
        </div>
    </div>

    <script>
        let currentLoanIndex = null;

        window.addEventListener('load', () => {
            try {
                const savedData = localStorage.getItem('loanApplication');
                
                if (!savedData) {
                    hideLoading();
                    showError('Application Not Found', 'No loan application data found. Please start a new application.');
                    setTimeout(() => {
                        window.location.href = 'eligibility.html';
                    }, 3000);
                    return;
                }

                let data;
                try {
                    data = JSON.parse(savedData);
                } catch (parseError) {
                    hideLoading();
                    showError('Data Corrupted', 'Your application data appears to be corrupted. Please start a new application.');
                    setTimeout(() => {
                        localStorage.removeItem('loanApplication');
                        window.location.href = 'eligibility.html';
                    }, 3000);
                    return;
                }

                if (!validateData(data)) {
                    hideLoading();
                    showError('Invalid Data', 'Your application data is incomplete or invalid. Please start a new application.');
                    setTimeout(() => {
                        localStorage.removeItem('loanApplication');
                        window.location.href = 'eligibility.html';
                    }, 3000);
                    return;
                }
                
                if (!data.loanOptions || data.loanOptions.length === 0) {
                    hideLoading();
                    displayNoOptions(data);
                    return;
                }

                const greeting = document.getElementById('greeting');
                greeting.textContent = `Dear ${sanitizeHTML(data.fullName)}, you qualify for a loan of up to KES ${data.maxLoan.toLocaleString()}. Please select your desired loan amount to complete your application.`;

                const loanCardsContainer = document.getElementById('loanCards');
                
                data.loanOptions.forEach((loan, index) => {
                    if (!validateLoanData(loan)) {
                        console.warn(`Invalid loan data at index ${index}`);
                        return;
                    }

                    const totalRepayment = calculateTotalRepayment(loan);
                    const monthlyInstallment = calculateMonthlyInstallment(loan);
                    const breakdown = calculateBreakdown(loan);
                    
                    const card = document.createElement('div');
                    card.className = 'loan-card';
                    card.style.animationDelay = `${index * 0.1}s`;
                    card.setAttribute('role', 'article');
                    card.setAttribute('aria-label', `Loan option for KES ${loan.amount.toLocaleString()}`);
                    
                    card.innerHTML = `
                        <div class="loan-amount">KES ${loan.amount.toLocaleString()}</div>
                        <div class="loan-details">
                            <div class="detail-row">
                                <span class="detail-label">Full Name:</span>
                                <span class="detail-value">${sanitizeHTML(data.fullName)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">National ID:</span>
                                <span class="detail-value">${sanitizeHTML(data.nationalId)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Loan Tracking Number:</span>
                                <span class="detail-value tracking-number">${sanitizeHTML(loan.trackingNumber)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Interest Rate:</span>
                                <span class="detail-value">${parseFloat(loan.interestRate).toFixed(2)}%</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Service Fee:</span>
                                <span class="detail-value">KES ${loan.serviceFee.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Repayment Period:</span>
                                <span class="detail-value">${loan.repaymentPeriod} days</span>
                            </div>
                        </div>
                        
                        <div class="highlight-box">
                            <div style="margin-bottom: 0.5rem;">
                                <strong>Total Repayment:</strong> KES ${totalRepayment.toLocaleString()}
                            </div>
                            ${monthlyInstallment ? `
                            <div>
                                <strong>Estimated Monthly Installment:</strong> KES ${monthlyInstallment.toLocaleString()}
                            </div>
                            ` : ''}
                        </div>

                        <div class="chart-container">
                            <div class="chart-title">Loan Breakdown</div>
                            <div class="pie-chart">
                                <div class="chart-visual" style="--principal-deg: ${breakdown.principalDeg}deg; --interest-deg: ${breakdown.interestDeg}deg;" aria-label="Loan breakdown chart"></div>
                                <div class="chart-legend">
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #d946ef;"></div>
                                        <span>Principal: KES ${loan.amount.toLocaleString()} (${breakdown.principalPercent}%)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #f59e0b;"></div>
                                        <span>Interest: KES ${breakdown.interest.toLocaleString()} (${breakdown.interestPercent}%)</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: #ef4444;"></div>
                                        <span>Fees: KES ${loan.serviceFee.toLocaleString()} (${breakdown.feePercent}%)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn-get-loan" onclick="selectLoan(${index})" aria-label="Select this loan option">Get Loan Now</button>
                    `;
                    
                    loanCardsContainer.appendChild(card);
                });

                hideLoading();
                
            } catch (error) {
                console.error('Error loading loan options:', error);
                hideLoading();
                showError('Unexpected Error', 'An unexpected error occurred while loading your loan options. Please try again or contact support.');
            }
        });

        function validateData(data) {
            if (!data) return false;
            if (!data.fullName || typeof data.fullName !== 'string') return false;
            if (!data.nationalId || typeof data.nationalId !== 'string') return false;
            if (!data.maxLoan || typeof data.maxLoan !== 'number') return false;
            return true;
        }

        function validateLoanData(loan) {
            if (!loan) return false;
            if (typeof loan.amount !== 'number' || loan.amount <= 0) return false;
            if (typeof loan.interestRate !== 'number' || loan.interestRate < 0) return false;
            if (typeof loan.serviceFee !== 'number' || loan.serviceFee < 0) return false;
            if (typeof loan.repaymentPeriod !== 'number' || loan.repaymentPeriod <= 0) return false;
            if (!loan.trackingNumber) return false;
            return true;
        }

        function sanitizeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function calculateTotalRepayment(loan) {
            const interest = (loan.amount * loan.interestRate) / 100;
            return loan.amount + interest + loan.serviceFee;
        }

        function calculateMonthlyInstallment(loan) {
            if (loan.repaymentPeriod < 30) return null;
            const totalRepayment = calculateTotalRepayment(loan);
            const months = Math.ceil(loan.repaymentPeriod / 30);
            return Math.ceil(totalRepayment / months);
        }

        function calculateBreakdown(loan) {
            const interest = (loan.amount * loan.interestRate) / 100;
            const total = loan.amount + interest + loan.serviceFee;
            
            const principalPercent = Math.round((loan.amount / total) * 100);
            const interestPercent = Math.round((interest / total) * 100);
            const feePercent = Math.round((loan.serviceFee / total) * 100);
            
            const principalDeg = (loan.amount / total) * 360;
            const interestDeg = principalDeg + ((interest / total) * 360);
            
            return {
                interest,
                principalPercent,
                interestPercent,
                feePercent,
                principalDeg,
                interestDeg
            };
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
        }

        function showError(title, message) {
            const loanCardsContainer = document.getElementById('loanCards');
            const greeting = document.getElementById('greeting');
            greeting.style.display = 'none';
            
            loanCardsContainer.innerHTML = `
                <div class="error-container" role="alert">
                    <svg class="error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <h2 class="error-title">${sanitizeHTML(title)}</h2>
                    <p class="error-message">${sanitizeHTML(message)}</p>
                    <a href="index.html" class="btn-back">Back to Home</a>
                </div>
            `;
        }

        function displayNoOptions(data) {
            const greeting = document.getElementById('greeting');
            greeting.style.display = 'none';
            
            const loanCardsContainer = document.getElementById('loanCards');
            loanCardsContainer.innerHTML = `
                <div class="no-options" role="alert">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                        <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <h2>No Loan Options Available</h2>
                    <p>Unfortunately, based on your current profile, we are unable to offer you a loan at this time. Please try again later or update your information.</p>
                    <a href="index.html" class="btn-back">Back to Home</a>
                </div>
            `;
        }

        function selectLoan(index) {
            currentLoanIndex = index;
            showConfirmationModal(index);
            
            if (typeof fbq !== 'undefined') {
                fbq('track', 'InitiateCheckout');
            }
            if (typeof gtag !== 'undefined') {
                gtag('event', 'begin_checkout', {
                    value: JSON.parse(localStorage.getItem('loanApplication')).loanOptions[index].amount
                });
            }
        }

        function showConfirmationModal(index) {
            const savedData = localStorage.getItem('loanApplication');
            const data = JSON.parse(savedData);
            const loan = data.loanOptions[index];
            
            const totalRepayment = calculateTotalRepayment(loan);
            const monthlyInstallment = calculateMonthlyInstallment(loan);
            const disbursableAmount = loan.amount - loan.serviceFee;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="modal-summary">
                    <div class="modal-detail">
                        <span class="modal-label">Loan Amount:</span>
                        <span class="modal-value">KES ${loan.amount.toLocaleString()}</span>
                    </div>
                    <div class="modal-detail">
                        <span class="modal-label">Service Fee:</span>
                        <span class="modal-value">KES ${loan.serviceFee.toLocaleString()}</span>
                    </div>
                    <div class="modal-detail">
                        <span class="modal-label">Amount to Receive:</span>
                        <span class="modal-value" style="color: #22c55e;">KES ${disbursableAmount.toLocaleString()}</span>
                    </div>
                    <div class="modal-detail">
                        <span class="modal-label">Interest Rate:</span>
                        <span class="modal-value">${loan.interestRate}%</span>
                    </div>
                    <div class="modal-detail">
                        <span class="modal-label">Repayment Period:</span>
                        <span class="modal-value">${loan.repaymentPeriod} days</span>
                    </div>
                    ${monthlyInstallment ? `
                    <div class="modal-detail">
                        <span class="modal-label">Monthly Installment:</span>
                        <span class="modal-value">KES ${monthlyInstallment.toLocaleString()}</span>
                    </div>
                    ` : ''}
                    <div class="modal-detail">
                        <span class="modal-label">Total Repayment:</span>
                        <span class="modal-value" style="color: #ef4444; font-size: 1.1rem;">KES ${totalRepayment.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="modal-highlight">
                    <strong>Important:</strong> By confirming, you agree to repay KES ${totalRepayment.toLocaleString()} within ${loan.repaymentPeriod} days. The loan will be disbursed to your M-PESA account.
                </div>
            `;
            
            const modal = document.getElementById('confirmModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentLoanIndex = null;
        }

        function confirmLoan() {
            if (currentLoanIndex === null) return;
            
            const savedData = localStorage.getItem('loanApplication');
            const data = JSON.parse(savedData);
            
            data.selectedLoan = data.loanOptions[currentLoanIndex];
            data.selectedLoan.disbursableAmount = data.selectedLoan.amount - data.selectedLoan.serviceFee;
            data.selectedLoan.totalRepayment = calculateTotalRepayment(data.selectedLoan);
            
            localStorage.setItem('loanApplication', JSON.stringify(data));
            
            if (typeof fbq !== 'undefined') {
                fbq('track', 'Purchase', {
                    value: data.selectedLoan.amount,
                    currency: 'KES'
                });
            }
            if (typeof gtag !== 'undefined') {
                gtag('event', 'purchase', {
                    value: data.selectedLoan.amount,
                    currency: 'KES'
                });
            }
            
            window.location.href = 'process-loan.html';
        }

        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        document.querySelectorAll('img[loading="lazy"]').forEach(img => {
            img.addEventListener('load', () => {
                img.classList.add('loaded');
            });
        });
    </script>
</body>
    </html>
